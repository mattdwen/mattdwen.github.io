<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>ASP.NET Core RC2 and Azure</title><meta name=viewport content="width=device-width"><link href=//fonts.googleapis.com/ rel=dns-prefetch><link href="http://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,700,700italic" rel=stylesheet type=text/css><link rel=stylesheet href=/css/main.e360.css><link rel=icon href=/favicon.png></head><body><button data-action=open-drawer id=drawer-button class=drawer-button><i class="fa fa-bars"></i></button><nav class=drawer tabindex=-1><div class=drawer-container><ul class=drawer-list role=navigation><li class=drawer-list-item><a href=/ ><i class="fa fa-home"></i>Home</a></li><li class=drawer-list-item><a href=http://www.group6.co.nz target=_blank><i class="fa fa-arrow-circle-o-right"></i>Group 6 Technologies</a></li><li class=drawer-list-item><a href=http://www.winerack.io target=_blank><i class="fa fa-arrow-circle-o-right"></i>winerack.io</a></li><li class=drawer-list-divider></li><li class="drawer-list-item drawer-list-title">Follow me</li><li class=drawer-list-item><a href=http://twitter.com/mattdwen target=_blank><i class="fa fa-twitter"></i>Twitter</a></li><li class=drawer-list-item><a href=http://www.flickr.com/mattdwen target=_blank><i class="fa fa-flickr"></i>Flickr</a></li><li class=drawer-list-item><a href=https://github.com/mattdwen target=_blank><i class="fa fa-github"></i>GitHub</a></li><li class=drawer-list-item><a href=http://instagram.com/mattdwen target=_blank><i class="fa fa-instagram"></i>Instagram</a></li><li class=drawer-list-item><a href=http://mattdwen.tumblr.com/ target=_blank><i class="fa fa-tumblr"></i>Tumblr</a></li></ul></div></nav><div class=drawer-overlay></div><main class=container id=container role=main><div class=surface><div class=surface-container><div class=content><aside class=cover role=banner><div class=cover-image data-load-image=/img/banner.c75b.jpg></div><div class=cover-container><a class=cover-logo href=/ ><img src=/img/avatar.0b80.jpg alt="Matt Dwen"></a><h1 class=cover-title>dwen.co.nz</h1><p class=cover-description>Sorter of Shit</p></div></aside><section class=wrapper tabindex=0><div class=wrapper-container><h2>ASP.NET Core RC2 and Azure</h2><p class=meta>15 Jun 2016</p><div class=post><p>I’ve been running a</p><strike>ASP.NET vNext</strike> <strike>ASP.NET 5</strike> ASP.NET Core site on Azure for about a year now. It’s taken me a while, but I’ve finally upgraded it to RC2.<p>However, when deploying to Azure, I was getting an error page with <strong>The specified CGI application encountered an error and the server terminated the process</strong> on the site, and nothing else.</p><p>Nothing in the error logs, and not much help on the web. There were some suggestions that it just didn’t work with the free and shared subscription plans, but this was already on the basic.</p><p>I scaffolded out a whole new RC2 site, and deployed that fine. So I rebuilt the site using the new RC2 template, which again worked fine.</p><p>When I deployed from Visual Studio.</p><p>A ha! I was using TeamCity to do the real deployment - and that was always giving me the CGI error.</p><p>After a lot of comparing files, I found that the generated <code class=highlighter-rouge>web.config</code> was different when using <code class=highlighter-rouge>dotnet publish</code> from the CLI, and from Visual Studio. In the VS output logs I could see it was setting a <code class=highlighter-rouge>DOTNET_CONFIGURE_AZURE</code> environment variable.</p><p><img src=/img/2016/aspnet-rc2/dotnet_configure_azure.f63b.png alt=DOTNET_CONFIGURE_AZURE></p><p>I couldn’t find a way to set the environment variable though so that when running <code class=highlighter-rouge>dotnet publish</code> from the CLI that I’d get the same output as from VS.</p><p>The <code class=highlighter-rouge>web.config</code> I was getting which was “bad” looked like:</p><div class=highlighter-rouge><pre class=highlight><code><span class=cp>&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class=nt>&lt;configuration&gt;</span>
  <span class=nt>&lt;system.webServer&gt;</span>
    <span class=nt>&lt;handlers&gt;</span>
      <span class=nt>&lt;add</span> <span class=na>name=</span><span class=s>"aspNetCore"</span> <span class=na>path=</span><span class=s>"*"</span> <span class=na>verb=</span><span class=s>"*"</span> <span class=na>modules=</span><span class=s>"AspNetCoreModule"</span> <span class=na>resourceType=</span><span class=s>"Unspecified"</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;/handlers&gt;</span>
    <span class=nt>&lt;aspNetCore</span> <span class=na>processPath=</span><span class=s>"%LAUNCHER_PATH%"</span> <span class=na>arguments=</span><span class=s>"%LAUNCHER_ARGS%"</span> <span class=na>stdoutLogEnabled=</span><span class=s>"false"</span> <span class=na>stdoutLogFile=</span><span class=s>".\logs\stdout"</span> <span class=na>forwardWindowsAuthToken=</span><span class=s>"false"</span><span class=nt>/&gt;</span>
  <span class=nt>&lt;/system.webServer&gt;</span>
<span class=nt>&lt;/configuration&gt;</span>
</code></pre></div><p>Somewhere along the lines the parameters were not getting replaced. The working version of <code class=highlighter-rouge>web.config</code> is:</p><div class=highlighter-rouge><pre class=highlight><code><span class=cp>&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class=nt>&lt;configuration&gt;</span>
  <span class=nt>&lt;system.webServer&gt;</span>
    <span class=nt>&lt;handlers&gt;</span>
      <span class=nt>&lt;add</span> <span class=na>name=</span><span class=s>"aspNetCore"</span> <span class=na>path=</span><span class=s>"*"</span> <span class=na>verb=</span><span class=s>"*"</span> <span class=na>modules=</span><span class=s>"AspNetCoreModule"</span> <span class=na>resourceType=</span><span class=s>"Unspecified"</span> <span class=nt>/&gt;</span>
    <span class=nt>&lt;/handlers&gt;</span>
    <span class=nt>&lt;aspNetCore</span> <span class=na>processPath=</span><span class=s>".\Focus.exe"</span> <span class=na>arguments=</span><span class=s>""</span> <span class=na>stdoutLogEnabled=</span><span class=s>"false"</span> <span class=na>stdoutLogFile=</span><span class=s>".\logs\stdout"</span> <span class=na>forwardWindowsAuthToken=</span><span class=s>"false"</span> <span class=nt>/&gt;</span>
  <span class=nt>&lt;/system.webServer&gt;</span>
<span class=nt>&lt;/configuration&gt;</span>
</code></pre></div><p><code class=highlighter-rouge>.\Focus.exe</code> comes from my project name, and is the generated exe from the new RC2 structure.</p><p>After some more digging I found that running <code class=highlighter-rouge>dotnet publish</code> from above the <code class=highlighter-rouge>project.json</code> directory has this problem every time. I’ve filled a bug for this on <a href=https://github.com/dotnet/cli/issues/3576>GitHub</a>.</p></div><footer class=footer role=contentinfo><p><small>&copy; 2016 Matt Dwen. All Rights Reserved.</small></p></footer></div></section></div></div></div></main><script src=/js/scripts.4f8c.js></script></body></html>