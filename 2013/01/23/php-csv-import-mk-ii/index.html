<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>PHP CSV import Mk.II</title><meta name=viewport content="width=device-width"><link href=//fonts.googleapis.com/ rel=dns-prefetch><link href="http://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,700,700italic" rel=stylesheet type=text/css><link rel=stylesheet href=/css/main.e360.css><link rel=icon href=/favicon.png></head><body><button data-action=open-drawer id=drawer-button class=drawer-button><i class="fa fa-bars"></i></button><nav class=drawer tabindex=-1><div class=drawer-container><ul class=drawer-list role=navigation><li class=drawer-list-item><a href=/ ><i class="fa fa-home"></i>Home</a></li><li class=drawer-list-item><a href=http://www.group6.co.nz target=_blank><i class="fa fa-arrow-circle-o-right"></i>Group 6 Technologies</a></li><li class=drawer-list-item><a href=http://www.winerack.io target=_blank><i class="fa fa-arrow-circle-o-right"></i>winerack.io</a></li><li class=drawer-list-divider></li><li class="drawer-list-item drawer-list-title">Follow me</li><li class=drawer-list-item><a href=http://twitter.com/mattdwen target=_blank><i class="fa fa-twitter"></i>Twitter</a></li><li class=drawer-list-item><a href=http://www.flickr.com/mattdwen target=_blank><i class="fa fa-flickr"></i>Flickr</a></li><li class=drawer-list-item><a href=https://github.com/mattdwen target=_blank><i class="fa fa-github"></i>GitHub</a></li><li class=drawer-list-item><a href=http://instagram.com/mattdwen target=_blank><i class="fa fa-instagram"></i>Instagram</a></li><li class=drawer-list-item><a href=http://mattdwen.tumblr.com/ target=_blank><i class="fa fa-tumblr"></i>Tumblr</a></li></ul></div></nav><div class=drawer-overlay></div><main class=container id=container role=main><div class=surface><div class=surface-container><div class=content><aside class=cover role=banner><div class=cover-image data-load-image=/img/banner.c75b.jpg></div><div class=cover-container><a class=cover-logo href=/ ><img src=/img/avatar.0b80.jpg alt="Matt Dwen"></a><h1 class=cover-title>dwen.co.nz</h1><p class=cover-description>Sorter of Shit</p></div></aside><section class=wrapper tabindex=0><div class=wrapper-container><h2>PHP CSV import Mk.II</h2><p class=meta>23 Jan 2013</p><div class=post><p>I’ve now written a bespoke CSV data importer, specifically for the data in this particular set. The first thing which surprised me was it’s only 201 lines of code shorter (1185 vs 1386). Having said that, the new importer doesn’t include the 447 lines of rules which describe the dataset to the generic importer.</p><p>I wasn’t expecting much from the new system. The algorithm is largely the same, though I was able to pre-define and load a number of parameters. There’s just a lot less switch and if statements figuring out how to handle the rules.</p><p>For the sake of comparison, I’ve removed most of the memory profiling points from the original importer, so I am only recording the metrics of both systems right after each line has been imported.</p><p><img src=/img/2013/jan/CSVCustom1_1024x512.7797.png alt=""></p><p>So, no savings in the memory department then. At least PHP is consistant in it’s memory allocations!</p><p>At least it was faster to execute:</p><blockquote><p>11m58s vs 11m49s</p></blockquote><p>9 seconds saving. Probably within the standard deviation if I ran this multiple times. A days work with totally new code, and no difference.</p><p>Here’s a magnified version of the memory traces.</p><p><img src=/img/2013/jan/CSVCustom2_1024x512.b070.png alt=""></p><p>So the new system is actually a little more memory hungry, but we’re talking an average of 95KB higher at any given time.</p><p>I had a very brief play with re-enabling the <a href=https://github.com/jimrubenstein/php-profiler>PHP MiniProfiler</a>. I was expecting to see big hits when scanning the filesystem for images and documents associated to each record, but surprisingly the (or maybe not) writes to the database were by far the worst offenders. I need to further investigate if it’s the ORM which is causing the slow queries, or the transaction itself.</p></div><footer class=footer role=contentinfo><p><small>&copy; 2016 Matt Dwen. All Rights Reserved.</small></p></footer></div></section></div></div></div></main><script src=/js/scripts.4f8c.js></script></body></html>